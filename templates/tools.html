{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2 class="gradient-text mb-4">üõ†Ô∏è Multi-Tools Manager</h2>
    <div class="row" id="tools-grid">
        <div class="col-12 text-center p-5">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- API Management Modal -->
<div class="modal fade" id="apiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="apiModalLabel">Manage APIs</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>Add New API</h6>
                    <div class="input-group">
                        <input type="text" id="api-url" class="form-control bg-dark text-white border-secondary" placeholder="API URL (use {placeholder})">
                        <button class="btn btn-primary" onclick="addApi()">Add</button>
                    </div>
                </div>
                <hr class="border-secondary">
                <h6>Existing APIs</h6>
                <div id="apis-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTool = '';

// Lazy loading implementation
const loadTools = async () => {
    try {
        const grid = document.getElementById('tools-grid');
        const res = await fetch('/api/tools');
        const tools = await res.json();
        
        grid.innerHTML = '';
        
        // Use document fragment for better performance
        const fragment = document.createDocumentFragment();
        
        Object.entries(tools).forEach(([id, t]) => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4 fade-in';
            col.innerHTML = `
                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">${t.name}</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${t.active ? 'checked' : ''} 
                                onchange="toggleTool('${id}', this.checked)">
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-info w-100" onclick="manageApis('${id}')">Manage APIs</button>
                    </div>
                </div>
            `;
            fragment.appendChild(col);
        });
        
        grid.appendChild(fragment);
    } catch (error) {
        console.error('Error loading tools:', error);
        document.getElementById('tools-grid').innerHTML = '<div class="alert alert-danger">Error loading tools. Please refresh.</div>';
    }
}

async function toggleTool(name, status) {
    try {
        await fetch('/api/tools/' + name, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({active: status})
        });
    } catch (e) {
        console.error('Toggle failed:', e);
    }
}

async function manageApis(toolName) {
    currentTool = toolName;
    document.getElementById('apiModalLabel').innerText = 'APIs for ' + toolName;
    const list = document.getElementById('apis-list');
    list.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
    
    try {
        const res = await fetch('/api/tools/' + toolName + '/apis');
        const apis = await res.json();
        list.innerHTML = apis.map(api => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border border-secondary rounded">
                <div class="text-truncate me-2" title="${api.url}">${api.url}</div>
                <button class="btn btn-sm btn-danger" onclick="removeApi(${api.id})">Remove</button>
            </div>
        `).join('') || '<p class="text-muted">No APIs configured</p>';
    } catch (e) {
        list.innerHTML = '<p class="text-danger">Failed to load APIs</p>';
    }
    
    new bootstrap.Modal(document.getElementById('apiModal')).show();
}

async function addApi() {
    const urlInput = document.getElementById('api-url');
    const url = urlInput.value;
    if(!url) return;
    
    try {
        await fetch('/api/tools/' + currentTool + '/apis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url})
        });
        urlInput.value = '';
        manageApis(currentTool);
    } catch (e) {
        alert('Failed to add API');
    }
}

async function removeApi(apiId) {
    if(!confirm('Delete this API?')) return;
    try {
        await fetch('/api/tools/' + currentTool + '/apis/' + apiId, {method: 'DELETE'});
        manageApis(currentTool);
    } catch (e) {
        alert('Failed to remove API');
    }
}

// Initial load with small delay to ensure base is ready
setTimeout(loadTools, 100);
</script>

<style>
.fade-in {
    animation: fadeIn 0.5s ease-in;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}