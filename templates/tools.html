{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2 class="gradient-text mb-4">üõ†Ô∏è Multi-Tools Manager</h2>
    <div class="row" id="tools-grid"></div>
</div>

<!-- API Management Modal -->
<div class="modal fade" id="apiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="apiModalLabel">Manage APIs</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>Add New API</h6>
                    <div class="input-group">
                        <input type="text" id="api-url" class="form-control bg-dark text-white border-secondary" placeholder="API URL (use {placeholder})">
                        <button class="btn btn-primary" onclick="addApi()">Add</button>
                    </div>
                </div>
                <hr class="border-secondary">
                <h6>Existing APIs</h6>
                <div id="apis-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTool = '';

async function loadTools() {
    const res = await fetch('/api/tools');
    const tools = await res.json();
    const grid = document.getElementById('tools-grid');
    grid.innerHTML = Object.entries(tools).map(([id, t]) => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">${t.name}</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" ${t.active ? 'checked' : ''} 
                            onchange="toggleTool('${id}', this.checked)">
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-info w-100" onclick="manageApis('${id}')">Manage APIs</button>
                </div>
            </div>
        </div>
    `).join('');
}

async function toggleTool(name, status) {
    await fetch('/api/tools/' + name, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({active: status})
    });
    loadTools();
}

async function manageApis(toolName) {
    currentTool = toolName;
    document.getElementById('apiModalLabel').innerText = 'APIs for ' + toolName;
    const res = await fetch('/api/tools/' + toolName + '/apis');
    const apis = await res.json();
    const list = document.getElementById('apis-list');
    list.innerHTML = apis.map(api => `
        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border border-secondary rounded">
            <div class="text-truncate me-2" title="${api.url}">${api.url}</div>
            <button class="btn btn-sm btn-danger" onclick="removeApi(${api.id})">Remove</button>
        </div>
    `).join('') || '<p class="text-muted">No APIs configured</p>';
    new bootstrap.Modal(document.getElementById('apiModal')).show();
}

async function addApi() {
    const url = document.getElementById('api-url').value;
    if(!url) return;
    await fetch('/api/tools/' + currentTool + '/apis', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url})
    });
    document.getElementById('api-url').value = '';
    manageApis(currentTool);
}

async function removeApi(apiId) {
    await fetch('/api/tools/' + currentTool + '/apis/' + apiId, {method: 'DELETE'});
    manageApis(currentTool);
}

loadTools();
</script>
{% endblock %}